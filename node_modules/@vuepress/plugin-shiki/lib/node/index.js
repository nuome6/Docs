import{bundledLanguages as A,createHighlighter as H,isSpecialLang as W}from"shiki";import{bundledLanguages as we}from"shiki";import{resolveWhitespacePosition as E,lineNumbers as P,collapsedLines as C}from"@vuepress/highlighter-helper";import{isPlainObject as T}from"vuepress/shared";import{Logger as x,getModulePath as p}from"@vuepress/helper";import{customAlphabet as M}from"nanoid";import{transformerNotationDiff as j,transformerNotationFocus as F,transformerNotationHighlight as S,transformerNotationErrorLevel as D,transformerNotationWordHighlight as O,transformerMetaWordHighlight as q,transformerRenderWhitespace as R,transformerCompactLineOptions as _}from"@shikijs/transformers";import{colors as m}from"vuepress/utils";const f=Object.keys(A),G=t=>{const e={},i=t.render.bind(t);return t.render=(s,r={})=>(e.path=r.filePathRelative,i(s,r)),()=>e.path||"dynamic pages"},I=async({langs:t=f,langAlias:e={},defaultLang:i,shikiSetup:s,...r}={})=>{const n=await H({langs:t,langAlias:e,themes:"themes"in r?Object.values(r.themes):[r.theme??"nord"]});return await s?.(n),n},U=/\[\\!code/g,z={name:"vuepress:add-class",pre(t){this.addClassToHast(t,"vp-code")}},B={name:"vuepress:cleanup",pre(t){delete t.properties.tabindex}},J={name:"vuepress:remove-escape",postprocess(t){return t.replace(U,"[!code")}},K={name:"vuepress:empty-line",code(t){t.children.forEach(e=>{e.type==="element"&&e.tagName==="span"&&Array.isArray(e.properties.class)&&e.properties.class.includes("line")&&e.children.length===0&&e.children.push({type:"element",tagName:"wbr",properties:{},children:[]})})}},Q=t=>{const e=[];return t.notationDiff&&e.push(j()),t.notationFocus&&e.push(F({classActiveLine:"has-focus",classActivePre:"has-focused-lines"})),t.notationHighlight&&e.push(S()),t.notationErrorLevel&&e.push(D()),t.notationWordHighlight&&(e.push(O()),e.push(q())),e.push(z,B,J,K),e},V=(t,e=!1)=>{const i=E(t,e);return i===!1?[]:[R({position:i})]},X=/-vue$/,v="@vuepress/plugin-shiki",$=new x(v),Y=M("abcdefghijklmnopqrstuvwxyz",10),L=t=>t.match(/^([^ :[{]+)/)?.[1]?.replace(X,"").toLowerCase()??"",Z=(t,e)=>{const i=`\\b${e}\\s*=\\s*(?<quote>['"])(?<content>.+?)\\k<quote>(\\s|$)`,s=new RegExp(i,"i");return t.match(s)?.groups?.content??null},ee=t=>{const e=t.replace(/^(?:\[.*?\])?.*?([\d,-]+).*/,"$1").trim(),i=[];return e?(e.split(",").map(s=>s.split("-").map(r=>parseInt(r,10))).forEach(([s,r])=>{s&&r?i.push(...Array.from({length:r-s+1},(n,l)=>s+l)):i.push(s)}),i.map(s=>({line:s,classes:["highlighted"]}))):[]},y=new Set,te=(t,e,{defaultLang:i,logLevel:s},r)=>{let n=L(t);return n&&!e.includes(n)&&!W(n)&&(s!=="silent"&&!y.has(n)&&($.warn(`Missing ${m.cyan(t)} highlighter, ${i?`use ${m.cyan(i)} to highlight instead.`:"skip highlighting"}`),y.add(n)),s==="debug"&&$.info(`Unknown language ${m.cyan(n)} found in ${m.cyan(r())}`),n=i||"plain"),n},se=/\{\{[^]*?\}\}/g,re=(t,e)=>t.replace(se,i=>{let s=e.get(i);return s||(s=Y(),e.set(i,s)),s}),ie=(t,e)=>{let i=t;return e.forEach((s,r)=>{i=i.replaceAll(s,r)}),i},ne=(t,e)=>{const i=new Map;return ie(e(re(t,i).trimEnd()),i)},oe=(t,e,i)=>{const s=Q(e),r=t.getLoadedLanguages();return(n,l,a)=>ne(n,h=>t.codeToHtml(h,{lang:te(l,r,e,i),meta:{__raw:a},transformers:[...s,...e.highlightLines??!0?[_(ee(a))]:[],...V(a,e.whitespace),...e.transformers??[]],..."themes"in e?{themes:e.themes,defaultColor:!1}:{theme:e.theme??"nord"}}))},b=/{([\d,-]+)}/,ae=t=>{const e=t.renderer.rules.fence;t.renderer.rules.fence=(...i)=>{const[s,r]=i,n=s[r],l=n.info||"",a=l.match(b);if(!a)return e(...i);n.info=l.replace(b,"").trim();const h=a[1];return n.info+=` ${h}`,e(...i)}},le=/<pre([\s\S]*?)style="([^"]*)"([^>]*)>/,pe=(t,{preWrapper:e=!0}={})=>{const i=t.renderer.rules.fence;t.renderer.rules.fence=(...s)=>{let r=i(...s);if(!r.startsWith("<pre"))return r;const[n,l,a]=s,h=n[l],c=h.info?t.utils.unescapeAll(h.info).trim():"",o=L(c),g=`${a.langPrefix}${o}`;if(!e)return r=r.replace(/<code[^]*?>/,"<code>"),r=`<pre class="${g}"${r.slice(4)}`,r;const u=Z(c,"title")||o;let d="";return r=r.replace(le,(ge,w,k,N)=>(d=k.trim(),`<pre ${w.trim()}${N.trimEnd()}>`)),`<div class="${g}" data-highlighter="shiki" data-ext="${o}" data-title="${u}" style="${d}">${r}</div>`}},he=(t,{lineNumbers:e=!0,highlightLines:i=!0,collapsedLines:s="disable",notationDiff:r,notationErrorLevel:n,notationFocus:l,notationHighlight:a,notationWordHighlight:h,whitespace:c})=>{const o=[`import "${p("@vuepress/highlighter-helper/styles/base.css",import.meta)}"`,`import "${p(`${v}/styles/shiki.css`,import.meta)}"`],g=[];e!=="disable"&&o.push(`import "${p("@vuepress/highlighter-helper/styles/line-numbers.css",import.meta)}"`),(i||a)&&o.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),r&&o.push(`import "${p("@vuepress/highlighter-helper/styles/notation-diff.css",import.meta)}"`),n&&o.push(`import "${p("@vuepress/highlighter-helper/styles/notation-error-level.css",import.meta)}"`),l&&o.push(`import "${p("@vuepress/highlighter-helper/styles/notation-focus.css",import.meta)}"`),a&&o.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",import.meta)}"`),h&&o.push(`import "${p("@vuepress/highlighter-helper/styles/notation-word-highlight.css",import.meta)}"`),c&&o.push(`import "${p("@vuepress/highlighter-helper/styles/whitespace.css",import.meta)}"`),s!=="disable"&&(o.push(`import "${p("@vuepress/highlighter-helper/styles/collapsed-lines.css",import.meta)}"`,`import { setupCollapsedLines } from "${p("@vuepress/highlighter-helper/client",import.meta)}"`),g.push("setupCollapsedLines()"));let u=o.join(`
`);return g.length&&(u+=`

export default {
  setup() {
    ${g.join(`
    `)}
  }
}
`),t.writeTemp("shiki/config.js",u)},ce=(t={})=>e=>{const{code:i}=e.options.markdown,s={...T(i)?i:{},...t};return s.logLevel??=e.env.isDebug?"debug":"warn",s.preWrapper??=!0,s.lineNumbers??=!0,s.collapsedLines??="disable",{name:"@vuepress/plugin-shiki",extendsMarkdown:async r=>{const{preWrapper:n,lineNumbers:l,collapsedLines:a}=s,h=G(r),c=await I(s);r.options.highlight=oe(c,s,h),r.use(ae),r.use(pe,{preWrapper:n}),n&&(r.use(P,{lineNumbers:l}),r.use(C,{collapsedLines:a}))},clientConfigFile:()=>he(e,s)}};export{f as bundledLanguageNames,we as bundledLanguages,ce as shikiPlugin};
//# sourceMappingURL=index.js.map
