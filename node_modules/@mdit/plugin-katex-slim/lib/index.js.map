{"version":3,"file":"index.js","sources":["../src/plugin.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/consistent-type-imports */\nimport { createRequire } from \"node:module\";\n\nimport { escapeHtml } from \"@mdit/helper\";\nimport { tex } from \"@mdit/plugin-tex\";\nimport type { KatexOptions as OriginalKatexOptions } from \"katex\";\nimport type MarkdownIt from \"markdown-it\";\n\nimport type {\n  KatexToken,\n  MarkdownItKatexOptions,\n  TeXTransformer,\n} from \"./options.js\";\n\nconst require = createRequire(import.meta.url);\n\nlet isKatexInstalled = true;\nlet katexLib: typeof import(\"katex\");\n\ntry {\n  katexLib = (await import(\"katex\"))\n    .default as unknown as typeof import(\"katex\");\n} catch {\n  isKatexInstalled = false;\n}\n\nconst katexInline = (\n  tex: string,\n  options: OriginalKatexOptions,\n  transformer?: TeXTransformer,\n): string => {\n  let result: string;\n\n  try {\n    result = katexLib.renderToString(tex, {\n      ...options,\n      displayMode: false,\n    });\n  } catch (error) {\n    if (options.throwOnError) console.warn(error);\n\n    result = `<span class='katex-error' title='${escapeHtml(\n      (error as Error).toString(),\n    )}'>${escapeHtml(tex)}</span>`;\n  }\n\n  return transformer?.(result, false) ?? result;\n};\n\nconst katexBlock = (\n  tex: string,\n  options: OriginalKatexOptions,\n  transformer?: TeXTransformer,\n): string => {\n  let result: string;\n\n  try {\n    result = `<p class='katex-block'>${katexLib.renderToString(tex, {\n      ...options,\n      displayMode: true,\n    })}</p>\\n`;\n  } catch (error) {\n    if (options.throwOnError) console.warn(error);\n\n    result = `<p class='katex-block katex-error' title='${escapeHtml(\n      (error as Error).toString(),\n    )}'>${escapeHtml(tex)}</p>\\n`;\n  }\n\n  return transformer?.(result, true) ?? result;\n};\n\nexport const katex = <MarkdownItEnv = unknown>(\n  md: MarkdownIt,\n  options: MarkdownItKatexOptions<MarkdownItEnv> = {},\n): void => {\n  if (!isKatexInstalled) {\n    console.error('[@mdit/plugin-katex]: \"katex\" not installed!');\n\n    return;\n  }\n\n  const {\n    allowInlineWithSpace = false,\n    mathFence = false,\n    mhchem = false,\n    logger = (errorCode: string): string =>\n      errorCode === \"newLineInDisplayMode\" ? \"ignore\" : \"warn\",\n    transformer,\n    ...userOptions\n  } = options;\n\n  if (mhchem) require(\"katex/contrib/mhchem\");\n\n  md.use(tex, {\n    allowInlineWithSpace,\n    mathFence,\n    render: (content: string, displayMode: boolean, env: MarkdownItEnv) => {\n      const katexOptions = {\n        strict: (\n          errorCode:\n            | \"unknownSymbol\"\n            | \"unicodeTextInMathMode\"\n            | \"mathVsTextUnits\"\n            | \"commentAtEnd\"\n            | \"htmlExtension\"\n            | \"newLineInDisplayMode\",\n          errorMsg: string,\n          token: KatexToken,\n        ): string => logger(errorCode, errorMsg, token, env) ?? \"ignore\",\n        throwOnError: false,\n        ...userOptions,\n      };\n\n      return displayMode\n        ? katexBlock(content, katexOptions, transformer)\n        : katexInline(content, katexOptions, transformer);\n    },\n  });\n};\n"],"names":["require","createRequire","isKatexInstalled","katexLib","katexInline","tex","options","transformer","result","error","escapeHtml","katexBlock","katex","md","allowInlineWithSpace","mathFence","mhchem","logger","errorCode","userOptions","content","displayMode","env","katexOptions","errorMsg","token"],"mappings":"6HAcA,MAAMA,EAAUC,EAAc,YAAY,GAAG,EAE7C,IAAIC,EAAmB,GACnBC,EAEJ,GAAI,CACFA,GAAY,aAAa,OAAO,GAC7B,OACL,MAAQ,CACND,EAAmB,EACrB,CAEA,MAAME,EAAc,CAClBC,EACAC,EACAC,IACW,CACX,IAAIC,EAEJ,GAAI,CACFA,EAASL,EAAS,eAAeE,EAAK,CACpC,GAAGC,EACH,YAAa,EACf,CAAC,CACH,OAASG,EAAO,CACVH,EAAQ,cAAc,QAAQ,KAAKG,CAAK,EAE5CD,EAAS,oCAAoCE,EAC1CD,EAAgB,SAAS,CAC5B,CAAC,KAAKC,EAAWL,CAAG,CAAC,SACvB,CAEA,OAAOE,IAAcC,EAAQ,EAAK,GAAKA,CACzC,EAEMG,EAAa,CACjBN,EACAC,EACAC,IACW,CACX,IAAIC,EAEJ,GAAI,CACFA,EAAS,0BAA0BL,EAAS,eAAeE,EAAK,CAC9D,GAAGC,EACH,YAAa,EACf,CAAC,CAAC;AAAA,CACJ,OAASG,EAAO,CACVH,EAAQ,cAAc,QAAQ,KAAKG,CAAK,EAE5CD,EAAS,6CAA6CE,EACnDD,EAAgB,SAAS,CAC5B,CAAC,KAAKC,EAAWL,CAAG,CAAC;AAAA,CACvB,CAEA,OAAOE,IAAcC,EAAQ,EAAI,GAAKA,CACxC,EAEaI,EAAQ,CACnBC,EACAP,EAAiD,CAAA,IACxC,CACT,GAAI,CAACJ,EAAkB,CACrB,QAAQ,MAAM,8CAA8C,EAE5D,MACF,CAEA,KAAM,CACJ,qBAAAY,EAAuB,GACvB,UAAAC,EAAY,GACZ,OAAAC,EAAS,GACT,OAAAC,EAAUC,GACRA,IAAc,uBAAyB,SAAW,OACpD,YAAAX,EACA,GAAGY,CACL,EAAIb,EAEAU,GAAQhB,EAAQ,sBAAsB,EAE1Ca,EAAG,IAAIR,EAAK,CACV,qBAAAS,EACA,UAAAC,EACA,OAAQ,CAACK,EAAiBC,EAAsBC,IAAuB,CACrE,MAAMC,EAAe,CACnB,OAAQ,CACNL,EAOAM,EACAC,IACWR,EAAOC,EAAWM,EAAUC,EAAOH,CAAG,GAAK,SACxD,aAAc,GACd,GAAGH,CACL,EAEA,OAAOE,EACHV,EAAWS,EAASG,EAAchB,CAAW,EAC7CH,EAAYgB,EAASG,EAAchB,CAAW,CACpD,CACF,CAAC,CACH"}